;; (mapcar #'(lambda (p) (asdf:load-system p) (use-package p)) '(util spec-func ran gnuplot scordatura))

(definst violin violin normal-violin-tuning 13.75 '(14 22 32 48))
(definst viola viola normal-viola-tuning 13.75 '(10 14 22 32))
(definst cello cello normal-cello-tuning 13.75 '(5 7 11 16))

(defparameter instlist '((flute 6) (clarinet 4) (sax 3) (violin 2) (viola 0) (cello 1) (perc1 5) (perc2 7)))

(defun rwalk-with-bounds (x0 y0 xfunc yfunc xmax lower-bound upper-bound)
  "Returns a list containing a list of x-values and a list of y-values representing the coordinates
   of a random walk.

   x0,y0: the starting coordinates of the walk
   xfunc, yfunc: closures that will be evaluated to produce steps in the walk
   xmax: the maximum x value
   ymin, ymax: closures that take an x value as an argument that represent the vertical boundaries of the walk.  
   	       steps that would cross the boundaries will be set to the appropriate boundary."
  (labels ((rec (x y)
	     (if (>= (car x) xmax)
		 (list (reverse x) (reverse y))
		 (let ((xstep (funcall xfunc))
		       (ystep (funcall yfunc)))
		   (let ((xx (+ (car x) xstep)))
		     (rec (cons xx x)
			  (cond ((> (+ ystep (car y)) (funcall upper-bound xx))
				 (cons (funcall upper-bound xx) y))
				((< (+ ystep (car y)) (funcall lower-bound xx))
				 (cons (funcall lower-bound xx) y))
				(t (cons (+ (car y) ystep) y)))))))))
    (rec (list x0) (list y0))))

(defun make-rwalks (&key (x0 0.0)
		      (y0 60.0)
		      (xmax 180.0)
		      (model-rwalk-xfunc (lambda () (poisson-proc 10.0 60.0)))
		      (model-rwalk-yfunc (lambda () (* (exponential 0.2) (- (* (random 2) 2) 1))))
		      (model-upper-bound 70.0)
		      (model-lower-bound 55.0)
		      (bump-min 0.0)
		      (bump-max 2.0)
		      (rwalk-xfunc model-rwalk-xfunc)
		      (rwalk-yfunc (lambda () (* (- (* (random 2) 2) 1) (random 0.5))))
		      (nwalks 1))
  (let ((model (rwalk-with-bounds x0
				  y0
				  model-rwalk-xfunc
				  model-rwalk-yfunc
				  xmax
				  (lambda (x) (declare (ignore x)) model-lower-bound)
				  (lambda (x) (declare (ignore x)) model-upper-bound)))
	(bump-func (lambda (x) (let ((beta-pdf-max (beta-pdf 0.5 5.0 5.0)))
				 (+
				  (*
				   (/
				    (beta-pdf (scale x x0 xmax 0.0 1.0) 5.0 5.0)
				    beta-pdf-max)
				   (- bump-max bump-min))
				  bump-min)))))
    (let ((model-2dplf (2dplf (car model) (cadr model))))
      (let ((lower-bound (lambda (x) (- (funcall model-2dplf x) (funcall bump-func x))))
	    (upper-bound (lambda (x) (+ (funcall model-2dplf x) (funcall bump-func x)))))
	(list (cons 'model model)
	      (cons 'lower-bound (list (car model) (mapcar #'(lambda (x) (funcall lower-bound x)) (car model))))
	      (cons 'upper-bound (list (car model) (mapcar #'(lambda (x) (funcall upper-bound x)) (car model))))
	      (cons 'rwalk (mapcar #'(lambda (x) (declare (ignore x))
					     (rwalk-with-bounds x0
								y0
								rwalk-xfunc
								rwalk-yfunc
								;;(lambda () (/ (round (* (- (* (random 1.0) 2) 1) 2.0)) 2.0))
								xmax
								lower-bound
								upper-bound))
				   (arithm-seq (- nwalks 1)))))))))

(defun plot-rwalks (lst)
  (let ((model (cdr (assoc 'model lst)))
	(lower-bound (cdr (assoc 'lower-bound lst)))
	(upper-bound (cdr (assoc 'upper-bound lst)))
	(rw (cdr (assoc 'rwalk lst))))
    (let ((rw1 (make-piecewise-coords (car (nth 0 rw)) (cadr (nth 0 rw))))
	  (rw2 (make-piecewise-coords (car (nth 1 rw)) (cadr (nth 1 rw))))
	  (rw3 (make-piecewise-coords (car (nth 2 rw)) (cadr (nth 2 rw))))
	  (rw4 (make-piecewise-coords (car (nth 3 rw)) (cadr (nth 3 rw))))
	  (rw5 (make-piecewise-coords (car (nth 4 rw)) (cadr (nth 4 rw))))
	  (rw6 (make-piecewise-coords (car (nth 5 rw)) (cadr (nth 5 rw))))
	  (rw7 (make-piecewise-coords (car (nth 6 rw)) (cadr (nth 6 rw))))
	  (rw8 (make-piecewise-coords (car (nth 7 rw)) (cadr (nth 7 rw)))))
      (lplot (flatten1 (mapcar #'(lambda (lst) (list (car lst) (cadr lst) "with linespoints"))
		     ;;(list model lower-bound upper-bound rw1 rw2 rw3 rw4 rw5 rw6 rw7 rw8))))))
		     (list rw1 rw2 rw3 rw4 rw5 rw6 rw7 rw8))))))
  lst)

(defun find-closest-time (time inst-name dir &optional (subdiv-list '(1 3 4 5)))
  (let* ((filenames (flatten
		     (mapcar (lambda (subdiv)
			       (if (= subdiv 1)
				   (format nil "~A/~A_beats.txt" dir inst-name)
				   (format nil "~A/~A_subdivs_~A.txt" dir inst-name subdiv)))
			     subdiv-list)))
	 (res (labels ((rec (filenames time-acc tempo-acc phase-acc)
			 (if (null filenames)
			     (list (reverse time-acc) (reverse tempo-acc) (reverse phase-acc))
			     (let* ((dat (deinterleave 3 (read-list-from-file (car filenames))))
				    (times (car dat))
				    (tempos (second dat))
				    (phases (third dat))
				    (idx (find-closest time times)))
			       (rec (cdr filenames)
				    (cons (nth idx times) time-acc)
				    (cons (nth idx tempos) tempo-acc)
				    (cons (nth idx phases) phase-acc))))))
		(rec filenames '() '() '()))))
    (labels ((rec (times tempos phases closest-time closest-tempo closest-phase)
	       (if (null times)
		   (list closest-time closest-tempo closest-phase)
		   (if (< (abs (- time (car times))) (abs (- time closest-time)))
		       (rec (cdr times) (cdr tempos) (cdr phases) (car times) (car tempos) (car phases))
		       (rec (cdr times) (cdr tempos) (cdr phases) closest-time closest-tempo closest-phase)))))
      (rec (car res) (second res) (third res) (caar res) (car (second res)) (car (third res))))))

(defun pprint-closest-times-for-insts (times insts dir &optional (subdiv-list '(1 3 4 5)))
  (mapcar (lambda (time i)
	    (format t "~%EVENT: ~A	TIME: ~A~%" i time)
	    (mapcar (lambda (inst)
		      (let ((res (find-closest-time time inst dir subdiv-list)))
			(format t "~A: Bar ~A, Beat ~A~%"
				inst
				(+ 1 (floor (/ (third res) 4.0)))
				(+ 1 (mod (third res) 4)))))
		    insts))
	  times (arithm-seq (length times) :min 1)))

(defun pprint-closest-times-for-insts-with-pitches (times pitches insts dir &optional (subdiv-list '(1 3 4 5)))
  (mapcar (lambda (time pitch i)
	    (format t "~%EVENT: ~A	TIME: ~A~%" i time)
	    (mapcar (lambda (inst)
		      (let ((res (find-closest-time time inst dir subdiv-list)))
			(format t "~A: Bar ~A, Beat ~A, Pitch ~A, ~A, ~A, Partial: ~A, ~A, ~A~%"
				inst
				(+ 1 (floor (/ (third res) 4.0)))
				(+ 1 (mod (third res) 4))
				pitch
				(round pitch)
				(/ (round (* pitch 2.0)) 2.0)
				(/ (mtof pitch) 13.75)
				(round (/ (mtof pitch) 13.75))
				(/ (round (* (/ (mtof pitch) 13.75) 2.0)) 2.0))))
		    insts))
	  times pitches (arithm-seq (length times) :min 1)))

;; (defparameter *rwalks*
;;   (plot-rwalks (make-rwalks :x0 68.581
;; 			    :xmax 244.101
;; 			    :y0 69
;; 			    :model-upper-bound 96
;; 			    :model-lower-bound 67
;; 			    :bump-max 3
;; 			    :nwalks 8
;; 			    :model-rwalk-yfunc (lambda () (* (exponential 1.0) (- (* (random 2) 2) 1)))
;; 			    :rwalk-xfunc (lambda () (poisson-proc 20 60.0)))))

(defparameter *rwalks* '((MODEL
  (68.581 72.7724019258468 75.57287450013207 83.32422947269069
   85.65211495862894 87.0117150741888 87.656104661952 93.17479369551928
   137.51625852356295 152.14943557591255 154.4641475421229 158.29897211457757
   170.92944906026617 171.4673895074365 171.93853956151446 173.56579498348046
   183.17642614777793 187.01577022764025 189.85461810501064 196.2749942269207
   208.35493548814978 209.28006272896874 209.73540508889403 211.31740997913136
   222.80466764060668 226.45925666444828 230.6491703683035 238.3077742617919
   254.50782318046757)
  (69 71.11449864987337 71.7939608663884 73.14512748452539 71.26283586009416
   72.28402873271135 73.50751390766007 73.18861818069911 73.26885569048326
   73.15414672664198 73.5789462122594 73.86092978076584 74.86320774088752
   72.58379210975698 73.91194173801385 73.81668636490409 73.89691724649603
   73.98342529621765 75.07914615598973 76.25121188253648 74.80091580637978
   76.17774269618829 76.26387563786088 76.57559883950701 76.17958497036477
   76.5792607596312 75.05922676548116 76.46032693395388 77.29998168378968))
 (LOWER-BOUND
  (68.581 72.7724019258468 75.57287450013207 83.32422947269069
   85.65211495862894 87.0117150741888 87.656104661952 93.17479369551928
   137.51625852356295 152.14943557591255 154.4641475421229 158.29897211457757
   170.92944906026617 171.4673895074365 171.93853956151446 173.56579498348046
   183.17642614777793 187.01577022764025 189.85461810501064 196.2749942269207
   208.35493548814978 209.28006272896874 209.73540508889403 211.31740997913136
   222.80466764060668 226.45925666444828 230.6491703683035 238.3077742617919
   254.50782318046757)
  (69.0 71.11427192194625 71.79231720483526 73.11821139013993 71.21719512442499
   72.22411817941608 73.43989601299243 73.02676953726477 70.78404036305162
   70.1814273300568 70.58443087999603 70.86689843947717 72.18130858460101
   69.92471716444727 71.27341003228841 71.2529244717694 71.87115965774024
   72.20203025390185 73.48217605611642 75.06520646451507 74.26958371043177
   75.68652389275846 75.79178917403453 76.16679642158272 76.08037125577427
   76.52795056946377 75.039966392701 76.45952998303906 77.28803109683935))
 (UPPER-BOUND
  (68.581 72.7724019258468 75.57287450013207 83.32422947269069
   85.65211495862894 87.0117150741888 87.656104661952 93.17479369551928
   137.51625852356295 152.14943557591255 154.4641475421229 158.29897211457757
   170.92944906026617 171.4673895074365 171.93853956151446 173.56579498348046
   183.17642614777793 187.01577022764025 189.85461810501064 196.2749942269207
   208.35493548814978 209.28006272896874 209.73540508889403 211.31740997913136
   222.80466764060668 226.45925666444828 230.6491703683035 238.3077742617919
   254.50782318046757)
  (69.0 71.11472537780048 71.79560452794155 73.17204357891084 71.3084765957633
   72.34393928600662 73.57513180232773 73.35046682413345 75.75367101791491
   76.12686612322716 76.57346154452276 76.85496112205452 77.54510689717402
   75.24286705506681 76.55047344373932 76.38044825803877 75.92267483525183
   75.76482033853344 76.67611625586305 77.43721730055789 75.33224790232778
   76.66896149961812 76.73596210168722 76.9844012574313 76.27879868495528
   76.63057094979862 75.07848713826134 76.4611238848687 77.31193227074002))
 (RWALK
  ((68.581 69.56140134630265 76.18865499270383 76.55221318162384
    77.05739776747218 77.25146525085252 78.05042070199 86.39439374575934
    86.82307804733531 88.27302578367016 91.79629756796356 94.82598719720171
    97.57316969317846 99.43877100008714 108.30043575522761 110.65339632815332
    111.66719385113076 116.89274899674834 123.15063128403301 127.54569456048597
    128.85735477798937 128.98191570379825 132.00559881056407 133.9891500579568
    137.8702160146844 149.15402576020008 150.80962724363062 158.23203576194038
    160.00640134044545 160.5586536081913 161.12069161015464 162.19586713190967
    168.10537249058916 168.93740035089377 169.58527153854325 179.39052626713507
    183.00331970242465 186.79059348059226 195.33099653802552 198.6736304469497
    199.31801508380647 206.3942548043601 209.25343040345012 209.4974560491673
    217.13405107307045 217.71314792999192 219.39361695474247 220.06667664670186
    220.42795090244206 226.34001774476275 227.18471303777164 233.43849473047928
    233.75957206497236 234.596289341138 236.53915091511024 236.8586772580281
    237.85230774371038 240.14776497367515 240.59038404221727 241.06138458208275
    249.37432842718022)
   (69 69.4945968665601 71.89902948918264 71.9673856799374 72.04930647516915
    72.08282769396932 72.22061888305711 71.76725504770856 72.08457195009457
    73.39627056534141 73.17615141954873 73.30353270088928 73.40944106190928
    73.25069437249519 73.56463368062332 73.20306517127014 72.90753827310549
    72.48792056319567 72.09926276982583 72.39630876239409 72.1810512957538
    71.84090843420276 71.65122733582811 72.04770042967087 72.11684372224451
    72.25370927266408 72.38697550087548 72.11790847614975 72.14422392660794
    72.48180744082964 72.05566136923231 71.81503193769436 71.94553723754464
    72.34531879400915 72.80204246145445 72.34859252182522 72.82455784544992
    72.93910461813886 74.83393299508013 74.92324516648085 74.88404060817965
    75.1572814798947 75.64575657642489 76.05741076413054 76.15549025937133
    76.54946277856254 76.13281442188848 76.12415759569731 76.11915987017262
    76.51366800925433 76.36025634936806 75.57765849466396 75.62099879582769
    75.7760452132817 76.13454832958996 76.19334157238131 76.37593461591722
    76.55551393553122 76.57874884241171 76.60298319892837 77.03320628495402))
  ((68.581 76.85116924204159 77.39520058184269 79.40935259876605
    80.10600678677294 82.4799506597515 82.85128799474397 85.96082362314063
    89.83727717433194 90.3674087150178 93.48476800058992 94.21899916661745
    95.71892540212762 104.82802166970855 105.52355798385598 107.73565013584832
    110.65558266442183 121.90711894984284 123.2507158610083 125.25463415556113
    128.4452960184941 139.2310973988545 144.37923631880636 145.88790017347605
    146.23429401218647 151.9953316564944 152.7512169033232 154.6862152160852
    157.03329128257718 162.91837988645491 169.98758415709952 174.36002248062425
    175.14894291782946 180.77583212802105 183.44433303678645 185.29892832335455
    186.37460205735107 187.16873054235717 190.95552870397245 206.53867648001048
    210.0200806442007 217.75178218003248 227.40904731494658 231.61291568317256
    236.53287274113455 236.96755840579988 238.45615711574797 239.3473557652733
    240.84512055837376 242.8189624618038 246.9441919713764)
   (69 72.01366420965849 72.10764258909269 72.45408767658813 72.57326732660634
    72.97624778946857 73.05478485709023 71.5433580812 73.28290380132542
    73.29217970759194 73.3579492652849 73.00460625654429 72.96905023953548
    73.46397071428309 73.50074640658724 73.20888106887081 73.33659047236178
    73.06789895924581 72.5762096436039 72.2167472191189 72.04627665831579
    71.65241863174565 71.50069837724993 71.13169841307591 70.78844661374013
    70.43369338044134 70.43612961048632 70.59953958307013 70.7686079898977
    71.29433739564605 72.06827058129609 72.15857399972737 72.63591624433333
    72.36765602638484 71.98849637343963 72.05296797634612 72.14620383884503
    72.49764927755918 73.75474371592703 74.40416161917668 75.85963691896356
    76.16585739476089 76.19257208877133 75.25018823753865 76.13339272755512
    76.21336678797593 76.46873857458006 76.51457906582205 76.59192293833988
    76.69414567172933 76.90789938784259))
  ((68.581 68.74773876557839 69.09232066661879 70.03278830262833
    74.23884436966247 74.64881083639172 76.13872064303601 76.18248640525934
    79.03728136427284 79.16546409554329 81.3786702960167 89.1453990028798
    98.58791414626567 99.27413748587404 100.04064038365085 105.09120027713848
    110.52369893340713 113.90534343128876 114.79596987093326 120.40739091947852
    122.31151924851149 124.63751822087964 126.36177815143337 128.90369927751922
    132.51607084437384 136.7392732126811 137.98392956260466 139.12851322143197
    141.28138229935487 145.76005013461844 146.53540492678212 151.4656127441177
    153.2254338527886 167.65344506503274 168.34192383484728 170.1701332347965
    175.44448942255178 177.36475010509633 187.50751185666357 188.3557707930793
    190.87103676301598 191.30836153510944 191.84575592759265 191.85146134843467
    195.16226769774497 196.89104072873243 198.81398344385045 202.1732182255485
    202.59384473491673 204.90053182326878 204.96575547831023 211.028371084992
    215.05671485113587 216.24557063191503 216.3453230322643 219.9088418106786
    220.00016810331283 223.56451247252994 225.29393506599092 226.65134844899848
    230.1963956899046 235.51585059256155 236.0342874841396 241.56408749862828
    242.58014609972608 242.67112084636514 246.17321721636026)
   (69 69.08411717566652 69.25795346024937 69.73240168455587 71.46956562685644
    71.57071366492505 71.89038164299474 71.89796124234896 72.39028815402595
    72.41227891478472 72.82145646524934 73.33354483809659 73.24007770068515
    73.10401074171611 73.31531593754035 73.65736241813559 74.06006040757536
    73.99011829548355 73.72834608288386 74.0853942879356 73.69541910486339
    73.38646123326497 73.35074491237846 72.98146476856253 72.74328276842985
    73.117938119353 73.51230273320044 73.4814769080725 73.40822539996002
    73.18150076963803 73.25562554998832 73.66139657209278 73.38981505122375
    73.47563009172524 73.81505550824669 73.84452587919468 73.66837780674605
    74.12619287231466 74.52931721198514 74.70325682721963 74.28966276134263
    74.03013972804706 74.31214230452973 74.76375208228258 74.7925206084379
    75.02929399473517 74.97687516383367 75.25883412159871 75.02785589757595
    75.41226824129394 75.7826845022942 76.09865376172213 76.46299001009758
    76.16895307809841 76.44970190670432 76.22062778512495 76.42748456050025
    76.35018103638711 76.41983328005875 76.46022179761181 75.24522892737143
    75.94596270048086 76.04156618804562 76.62907127647439 76.68176142414319
    76.68647758749849 76.86801149763599))
  ((68.581 69.10317315283466 69.50646051847454 70.85258156354963
    70.95761465715022 73.96960329980483 83.7030575018831 90.37530559405894
    90.56017892217484 91.06979212404998 94.82744160174911 97.15732840285642
    97.39680090844561 99.24906588725688 100.52880055617109 100.5896037249741
    103.12932785176505 113.86577342802445 115.76469161715342 120.73900727330074
    121.33324429607761 122.6321841263002 125.38359296912617 125.38989594388337
    126.84690146223197 127.29184862571448 130.39018110609666 134.9706455498121
    135.59204969134188 139.16682877289645 140.74899452786076 146.20311069834855
    146.97494040349017 158.07561091498084 159.1480778198218 159.25860306230976
    161.90717316835597 164.43707658118015 167.9303647386515 171.95965358694934
    175.79038470695733 176.69699923885997 179.91697124892193 182.8878617390027
    182.96663862138723 183.18265920311165 183.4708707944744 183.58289770548694
    184.27659221099776 188.05790915085154 193.30351632572575 195.0484130377024
    195.68935846757944 196.73532999564299 196.8302562833944 198.24623233949507
    200.07230079537283 200.97954450095946 204.48400251760282 210.5592553058193
    213.86772046972308 222.98479409501945 227.0088376468684 228.7233671675101
    231.9800981325063 233.25442494120833 237.9132966182532 238.8047618534687
    246.17229080696606)
   (69 69.26342837003767 69.46688020274188 70.14595796610135 70.19894157369967
    71.40436631959092 72.80930188053185 73.24296048766354 73.22911955943212
    73.42985550996765 73.22759417760447 73.08748475736064 72.99796451646881
    73.00708628525061 73.48942361710988 73.31103355566789 73.68634690951494
    73.60054511794905 73.48764665204378 73.45521325325127 73.48831732771394
    73.37468558225403 73.73810833259195 73.77294220360062 73.50351976205418
    73.20291131671863 72.84130253525086 73.01744560509407 73.46236227215189
    73.94259937969427 73.76841782569178 73.4033743116893 73.37312518139731
    73.35780211286055 73.00476538280158 73.43199348123395 73.08503492092805
    72.76701066788449 72.83456071672252 73.0416307704136 72.64176841358578
    72.84371256223638 73.02594607940533 73.43998156146533 73.26987952533266
    73.61221967966868 73.61843374679009 73.4906728949806 73.89005610373509
    73.55552912047867 74.33504167756392 74.8002841846729 75.22867855283906
    75.21724839793232 75.61007808105492 75.61956277675253 75.19080916948107
    75.2371333346105 75.73629635253229 76.20015894982033 76.67012966150855
    76.29563232381518 76.42572340084561 75.78923427639715 75.31583137907212
    75.54452186720395 76.38713177892684 76.48552274420794 76.8679322334686))
  ((68.581 70.69270412441001 74.2502097854794 76.0023871183315
    85.01809018584774 95.6514953144291 97.08008211620036 103.8808680465441
    109.49520398256313 110.50305252214247 111.77969043188385 113.14075814156638
    116.5498257620139 116.90879803610575 117.65581970661277 118.54132361387936
    122.72437203098198 124.12594654946783 126.93227631056908 127.92370265209546
    128.49720073926395 128.57153537874805 133.0885243983761 141.4734543595091
    141.68319230779068 146.60951520170565 147.02256158232385 148.88794621195999
    156.71345773999016 158.11155030579414 158.88049796415507 160.09301636259556
    179.78505667099947 181.7351225484812 182.3002099933087 185.70735831538062
    188.29253153620377 189.31539541279264 192.85198013646402 196.01569247672947
    196.1900063084944 197.05332792872647 199.40265290854032 199.77000850530558
    201.19988372231285 204.16339950579984 206.86509910470403 208.32105665676383
    210.6025121253629 211.38636245873883 213.2339196879775 215.53264553116148
    226.6537651647237 233.92408021061544 239.19834669372213 239.32021575776713
    240.83842946425173 240.95753951641714 244.73445619739923)
   (69 70.0653073463599 71.47231748523055 71.86676563909721 71.7356378787705
    72.97074421874426 72.94563549876452 72.80843377852672 73.04961533793087
    73.51417127799355 73.90785069504217 73.7371529041076 73.56363206694583
    73.95411337992998 74.28143296889927 74.17278780496498 74.34901064797508
    74.11036651381804 73.70597422082133 73.6419896006354 73.78943161872411
    73.81149896448908 74.12516292181031 74.14677077973356 73.91171207130054
    73.43188601664254 73.89402082678033 73.82751304999987 73.90892770591691
    73.51484416644954 73.64075156704857 73.29136832443417 72.80849248873497
    72.43608082921038 72.06632235809653 72.14610642114222 72.7776154942999
    73.23895244539176 74.22361161032832 75.00175305887923 75.04441559844057
    75.01977437480711 74.99247930504669 74.88212734656027 75.18294512096453
    75.54655265716536 75.42394774955032 75.33781559782193 75.99795017196233
    76.16706390703753 76.47680422357017 76.69512414077212 76.52969970998862
    75.66518911617202 76.50606823188548 76.5124236544668 76.59140670886785
    76.59759178260144 76.79342419178415))
  ((68.581 72.79160872664224 77.19274879413199 77.24519042199539
    77.81045190406692 78.21226041048372 81.11476095344693 85.91904128903778
    86.30361510039451 86.90774753485238 94.05547389878409 95.31346912585337
    96.19802364610953 101.84015199698989 102.28757333588165 102.54880594317673
    103.46759610077079 104.6721945930361 104.69999237100225 117.21882014084636
    118.83713635344375 124.95228634911551 128.68208802301461 130.3580420123357
    135.54158800289804 137.02020652967283 138.70217913020696 151.24629187822975
    152.40711045184293 157.49687972629056 159.46473915904832 160.1185270618792
    164.43883444227288 164.89934191385638 165.87396646459183 167.25525579822127
    175.79378198947873 177.23862321961826 177.49709905945247 179.67387315235283
    180.57383615926943 192.0673595974601 192.88226479171342 193.51641891828257
    194.00324828995213 195.7343802103779 196.59262965878983 202.7581142636927
    203.57521465979482 203.73850433313098 208.3848855756205 210.88672425247896
    211.586810570742 213.97383343612873 218.59273494651853 227.75498917486638
    229.60246694329504 232.0093699316738 234.0754566655899 238.68754968416215
    240.38918319638307 240.93809040238463 251.12461458229285)
   (69 71.11892787425904 72.07268763231149 72.08174414432926 72.1887317125326
    72.24848591186608 72.74513873108617 71.51156023521622 71.78966735037052
    72.14721358783984 73.00821597467495 73.28823620374942 72.95675290205142
    72.77699678683028 72.75998906498116 73.18810235164725 73.35664339431331
    73.030758094918 73.4742226980785 73.16692451990737 72.77319320141862
    73.15844036529394 73.35489480145772 73.59120733432522 73.5576651937947
    73.10676628640114 73.52599274662643 73.66200922534921 73.84585430289833
    73.8230343472245 73.52167873348834 73.54477191081446 73.3592239981433
    73.40345976810815 73.06779981701756 73.51295138351236 73.76097040013356
    73.98630750323443 73.64517102464217 73.2095799768264 73.39115953240291
    74.02977148681879 74.23108826499632 74.38754644300556 74.50751187916089
    74.93284896168957 75.04673336439032 74.8663292502328 74.65679474565985
    74.89547533688231 74.66074549808407 76.06519852882344 76.16778717967226
    76.17014813657968 76.14198928686882 76.07011599125566 75.464280870149
    75.29506629814625 75.6795861065283 76.47939774290376 76.56806614099284
    76.59673253148088 77.12232481625237))
  ((68.581 69.54356961018836 70.38194726063662 70.85501756686966
    76.62197171821899 77.23671701318347 87.68761397898439 89.91770014130472
    90.42340824662534 93.56548076963198 95.88525903212346 96.9440521983266
    99.0401491162474 101.497785464824 103.33330565490304 108.92946085462485
    110.64320046789923 119.85185814269664 120.60362911770511 123.9213120361193
    129.56834155438537 132.53247014135633 136.4809739493456 138.02926777014878
    138.71696986515678 138.93929216777957 142.64710461922684 147.82672817379458
    148.99010644590686 149.68839501245816 155.09538923557417 155.85399674589274
    157.92889142025234 158.15570052243493 163.1358632288187 164.67082714722127
    168.1058591424259 172.05396292410074 172.88301941444342 175.7065526390075
    176.7242245630314 176.86416680444665 180.50049541637577 182.64433223976172
    186.410197268557 191.97498631978527 192.93893568366224 196.29314772142763
    200.11193994107973 200.8892103440674 202.7625386838457 205.04460259334448
    210.90020216034756 213.73281427368568 216.28619111455285 219.74925226758967
    227.45570533450595 228.41547380645548 228.87680933993144 230.57754625616911
    237.5800489655834 246.19397240578326)
   (69 69.4856010778341 69.90854238773292 70.14718680608391 71.97402848472667
    72.08770159387274 73.43768218822527 73.47669179786574 73.45584733309829
    73.25203778952881 73.42221290062531 73.0740387897863 72.90881577068006
    73.31384817434738 73.46919853481182 73.72821136068302 74.0518276631599
    74.24840063869952 74.55333559007474 74.31544936263263 74.1635389044938
    74.07755636943908 74.5335818532092 74.33937513595397 74.55846228888855
    74.22176550368538 73.94638335238582 73.91261861373253 73.95089404491809
    73.76466177644022 73.52813142825596 73.78712323375954 74.17319382885199
    74.16418259674431 74.18672963949466 74.31775066082992 74.12082819451224
    74.30429236600338 74.76326058147092 75.02944130172538 74.78646568166663
    75.20543354601254 74.84029529122634 74.7369264638675 74.63756064551546
    74.89396209561336 74.47027748625285 75.0641531199364 75.53933407104857
    75.50408967916098 75.93379308317841 75.53600362272051 76.06838357274344
    76.1704352080161 76.44849817379648 76.44148890447843 76.25946478173773
    75.83589209807258 75.73245058176356 75.10484996489137 76.32593596495883
    76.8690553271732))
  ((68.581 71.72238463054218 72.1173989396658 76.01310365583073
    90.25103673771113 90.78861457771774 91.04769205659859 92.6264134265267
    97.48277056478554 99.23475042302377 105.21604483289279 105.80391413035936
    113.23488320462464 115.77206398952983 122.61723653782691 128.31803475892997
    129.62416535434852 131.18743745809752 134.13450945053881 135.41495574260935
    135.93680610374935 139.41165892084237 139.74745520959848 142.0962682121923
    145.04009730297383 146.66429246077632 148.79573564104814 153.90167166542201
    154.03938586887813 154.96807509891525 159.98754546794146 162.07717877489006
    173.71686637631933 174.4433268902942 176.23931470983436 178.63019676881044
    178.72562630254538 179.82757729721067 180.454974667799 181.32822216870588
    182.91630804547228 187.998462804175 189.59161950150468 191.53574028840384
    193.03099900040806 193.36366402864647 199.11669788412553 203.69193134185292
    203.89279601109178 206.18396551206627 210.77796606675153 216.39368775996422
    217.61939640215033 219.57757124936484 235.8881379200513 241.72118811788994
    245.77262733608825)
   (69 70.58470755218343 70.78417625094706 71.86862225292973 73.2522306402156
    73.21193437143914 73.43063491202481 73.37035631436206 73.47132835760311
    73.53113591200484 73.64375704627102 73.22926454672499 73.01291819073114
    73.04073436035397 72.95672876116025 72.70298888506356 72.2450305294327
    72.11704266767795 72.54891239804658 72.74654983602116 72.68419678308813
    72.57060893113047 72.22384429473865 72.37764065290885 72.33030742885813
    71.99163392652322 72.24246253082634 72.33295717178761 72.22352253461312
    72.01508191227903 71.75190203543697 71.61412453010853 71.26141686553525
    71.30291293435722 71.48238409487342 71.7312987364506 71.90077977546812
    71.67625335306275 71.6826563871135 71.99531028049253 71.85281544127966
    72.64500941308691 73.36354739764757 73.8983098393196 74.26780153959307
    74.67159517034516 74.8963419876944 75.35672420647649 75.31442234002913
    75.61596175447218 76.03948395140169 76.16073002690105 76.15146315794694
    76.31822621161575 76.02070692474521 76.63722090755546 76.84722656968562)))))

(defun pprint-pitch-changes-for-some-insts (insts)
  (mapcar #'(lambda (inst)
	      (let ((rw (get-rwalk-for-inst inst))
		    (inst inst))
		(pprint-closest-times-for-insts-with-pitches (car rw)
							     (cadr rw)
							     (list inst)
							     "/Users/john/jmac/compositions/ECO/workspace")))
	  insts))

(defun pprint-pitch-changes-for-all-insts ()
  (pprint-pitch-changes-for-some-insts '(flute clarinet sax perc1 perc2 violin viola cello)))
  

(defun plot-one-inst (instnum &optional (round-precision 1.0))
  (let ((x (car (nth instnum (cdr (assoc 'rwalk *rwalks*)))))
	(y (round-to (cadr (nth instnum (cdr (assoc 'rwalk *rwalks*)))) round-precision)))
      (lplot (append (make-piecewise-coords x y) '("with linespoints")))))

(defun plot-multi (lst &optional (round-precision 1.0))
  (lplot
   (flatten1
    (mapcar #'(lambda (i)
		(let ((x (car (nth i (cdr (assoc 'rwalk *rwalks*)))))
		      (y (round-to (cadr (nth i (cdr (assoc 'rwalk *rwalks*)))) round-precision)))
		  (append (make-piecewise-coords x y) '("with linespoints"))))
	    lst))))

(defun get-rwalk-for-inst (inst-name)
  (nth (cadr (assoc inst-name instlist)) (cdr (assoc 'rwalk *rwalks*))))
		
